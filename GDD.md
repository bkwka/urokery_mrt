```markdown
Браузерная обучающая игра: "Межпланетный Рыцарский Турнир"

Дата: 2025-11-08  
Автор: Максим Демин & Copilot  
Версия документа: 0.5

---

Оглавление
1. Краткое описание проекта  
2. Цели и аудитория
3. Структура игры/сайта
4. Описание страниц/модулей структуры
4. Геймплей и «core loop»
5. Механики и правила  
6. Прогрессия уровней и генерация задач  
7. Монстры, герои и предметы  
8. Баланс HP и таймеров  
9. Монетизация и модель оплаты (текущий статус)  
10. Интерфейс / UX / экраны  
12. Туториал и онбоардинг  
12. Магазин / внутриигровая валюта / покупки за монеты  
13. Сценарии проигрыша и продолжения  
14. Арт- и аудиоспецификации  
15. Технические требования и архитектура  
16. Данные, API и модели данных  
17. Тестирование, аналитика и метрики  
18. План разработки и вехи (milestones)  

---

1. Краткое описание проекта
Игра — образовательная браузерная аркада. Игрок выбирает героя и сражается с последовательностью соперников, отвечая на примеры из таблицы умножения. Правильный ответ наносит урон сопернику. Неправильный ответ наносит урон игроку. Вселенная игры – наивное будущее. Игрок прилетает на арену, где проходит турнир. Его встречает устроитель турнира, который рассказывает про турнир. Далее игрок выбирает себе героя с уникальными способностями, за которого он будет играть. Игрок проходит тестовый раунд турнира, где он учится игровым механикам. После тестового раунда игрок начинает участие в турнире. Всего в турнире участвует 30 соперников с 5 планет, по 6 соперников с каждой планеты. Всего в игре 6 этапов, в каждом по 5 раундов. Примеры усложняются с каждым раундом. HP соперников и игрока, количество примеров увеличивается с каждым этапом. Во время игрового раунда игрок может использовать свои уникальные способности. Прогресс игры записывается при желании игрока. В игре есть описание планет, соперники которых участвуют в турнире. К каждой планете привязаны свои соперники, они показываются по мере продвижения игрока в турнире, если игрок еще не победил соперника, то на странице описания планет, соперник скрыт. Прогресс игрока показывает сколько примеров он решил, сколько по времени играл, на каком этапе и раунде он остановился. Игрок может продолжить игру с того момента, где он закончил, выбрать этап и раунд, чтобы еще раз потренироваться или начать заново. В игре есть монеты. За монеты игрок покупает себе нового героя, если он проиграл турнир. Чтобы заработать монеты, игрок проходит специальные раунды турнира.

Ключевые положения:
- Образовательная цель: закрепление таблицы умножения.
- UX-цель: игровой процесс должен удерживать детей 7–10 лет.
- Монеты — soft currency — выдаются только внутриигровыми действиями.
– Лор – наивное будущее. Это отражено в графике и соперниках.
– Решай примеры – побеждай соперников.
– Смотри, с каких планет прилетели соперники и свой прогресс.
– Выбирай героя с уникальными способностями.
– Покупай за монеты новых героев, если проиграл раунд.
– Всего 30 соперников, 5 планет, по 6 соперников на каждой.
– Всего 30 раундов, 6 этапов, 5 раундов в каждом этапе.

2. Цели и аудитория
- Основная цель: улучшение навыков умножения у детей 7–10 лет через игровую мотивацию.
- Дополнительная аудитория: родители и учителя — заинтересованы в отслеживании прогресса.
- Метрики успеха (MVP): среднее время сессии, завершённые уровни, точность ответов.

3. Структура игры/сайта
  1. Главный экран
    1.1. Планеты/соперники/прогресс
      1.1.2 Планета/соперники 1
      ...
      1.1.5 Планета/соперники 5
    1.2 Турнир
      1.2.1 Приветствие устроителя турнира
      1.2.2. Выбор героя
      1.2.3 Тестовый раунд
      1.2.4 Этап 1
        1.2.4.1 Раунд 1 – 5
        1.2.4.1.1 Раунд заработка монет/тренировка(если требуется)
        ...
      ...
      1.2.5 Этап 5
      1.2.6. Конец турнира
    1.3 Правила

4. Описание страниц/элементов страниц
  Кнопки на всех страницах: "настройки", "домой"
  1. Главный экран.
      Анимированная заставка.
      Кнопки: "начать игру", "прогресс", "продолжить", "настройки".
  2. Планеты/соперники/прогресс
      Прогресс.
      Планета 1 / соперники.
      Меню выбора планеты(вкладки).
  3. Приветствие устроителя турнира
      Изображение устроителя
      Баббл с текстом
      Кнопка "далее"
  4. Выбор героя
      Аватары героев с описаниями
      

3. Геймплей и «core loop»
Onboarding / первое посещение:
- Игрок попадает на главный экран меню.
- Доступен тестовый/показательный уровень без регистрации с предустановленным героем.
- Пользователь регистрируется (email/guest->convert позже) для сохранения прогресса.
- Игрок знакомится с помощником (навигация, подсказки), выбирает героя и получает стартовый пакет монет (малое кол-во).

Повторное посещение:
- Пользователь входит в профиль, видит прогресс, этапы, уровни, магазин, статистику.

Core loop:
- HeroSelect -> StageSelect -> LevelSelect -> Battle.
- Структура: 6 этапов (stages). В каждом этапе 5 уровней, всего 30 уровней.
- Перед первым уровнем каждого этапа показывается StageIntro — экран с информацией о новом этапе (тема, цель, особенности) и кнопкой "Начать этап".
- Перед появлением каждого нового раунда (нового монстра) показывается небольшой промежуточный экран-пауза (RoundIntro) с кнопкой "Дальше". RoundIntro:
  - отображает краткую подсказку (опционально: цель раунда, ожидаемые множители, подсказка героя),
  - даёт визуальную паузу и кнопку "Дальше" для продолжения.
  - служит для снижения монотонности и подготовки игрока.
- Battle:
  - На экране отображаются: изображение монстра (PNG), HP монстра (сердечки), HP игрока (сердечки), текущий пример (a × b), 3 варианта ответов и таймер для текущего примера (5s).
  - Пер-пример таймер: на каждый показанный пример у игрока есть 5 секунд. Если игрок не успевает дать ответ за эти 5 секунд — с него снимается 1 HP и показывается краткий feedback; затем показывается следующий пример (или, если HP дошёл до 0, — FailModal).
  - Игрок выбирает ответ:
    - Правильно: монстр теряет 1 HP.
    - Неправильно: игрок теряет 1 HP.
  - Победа: если HP монстра = 0 — показывается экран "Победа!" с кнопкой "Далее" (далее — либо StageIntro следующего этапа, либо RoundIntro/LevelSelect внутри текущего этапа).
  - Проигрыш: если playerHP <= 0 — показывается FailModal (см. раздел 12).
- Награды: за победу даются монеты и статистика (accuracy/time).

4. Механики и правила (подробно)
- HP игрока:
  - Базовый HP = 3; конкретный герой может давать бонус (hpBonus).
  - HP восстанавливается в начале каждого уровня / раунда (т.е. на каждый новый монстр игрок выходит с полным HP).
- Монстры:
  - Начальный HP варьируется по уровню (см. раздел 7).
  - До версии 1.2 использовался агрегированный таймер; в версии 1.2 таймер на каждый пример = 5 секунд.
  - Визуальные состояния: normal, hit, defeated.
- Задачи:
  - a, b ∈ [minF, maxF] в зависимости от уровня/этапа.
  - Одна задача — один пример умножения с тремя вариантами.
- Варианты ответов:
  - 3 кнопки — один верный, два правдоподобных отвлекающих.
  - Генерация отвлекающих учитывает близость к правильному ответу и структуру множителей, чтобы не давать очевидных неверных вариантов.
- Таймер на примере:
  - На каждый показанный пример отображается отсчёт 5s.
  - Истечение времени = считается как "неверный ответ" эквивалентно потере 1 HP игрока и переходу к следующему примеру (соответствующий визуальный feedback).
- RoundIntro (пауза перед раундами):
  - Появляется перед каждым новым монстром/раундом.
  - Показывает название/номер раунда, краткую подсказку по ожидаемым множителям/специфике раунда, и кнопку "Дальше".
  - RoundIntro длится до нажатия "Дальше" (не тайм-аутный) — даёт игроку контроль над началом следующего столкновения.
- Переходы и контроль:
  - Игрок переходит дальше по кнопке "Далее" после победы.
  - StageIntro и RoundIntro — обязательные остановки для контекстной информации и снижения монотонности.

5. Прогрессия уровней и генерация задач
- Всего уровней: 30, сгруппированы в 6 этапов (stages) по 5 уровней в каждом.
- Stage concept:
  - Каждый этап имеет тему/сложность/визуальную обвязку (например: «Тренировка на Лунной арене», «Битва в кольце астероидов», «Крепость комет» и т.д.).
  - StageIntro показывает название этапа, краткое описание, цель этапа и кнопку «Начать этап».
- Прогрессия множителей:
  - maxFactorForLevel(level) — линейный рост от 2 до 20 (уровни 1 → 30).
  - minFactorForLevel(level) — растёт внутри и между этапами, чтобы поздние уровни не содержали совсем простых примеров.
- Генератор задач:
  - Выбирает a, b из диапазона [minF, maxF].
  - Правильный ответ r = a * b.
  - Отвлекающие генерируются тремя стратегиями: близкие по величине (r ± smallDelta), изменение одного множителя, случайный валидный продукт в текущем диапазоне.
- Stage difficulty curve:
  - Рекомендуется повышать минимальный множитель при переходе на новый этап, особенно после этапа 4, чтобы сохранить возрастание сложности.
  - Внутри этапа уровни могут менять профиль (например, уровень 1 этапа — тренировочный; уровень 5 этапа — мини-босс с повышенным HP).

6. Монстры, герои и предметы
(без изменений по сравнению с v1.3, но добавлено соответствие монстров/уровней к этапам и RoundIntro)
- Каждому этапу можно сопоставить пул монстров соответствующей визуальной силы.
- На финальном уровне этапа можно назначать «мини-босса» с более высокой HP или особой анимацией.
- RoundIntro может показывать иконку монстра/краткий совет перед появлением монстра.

7. Баланс HP и таймеров
- MonsterHP(level) = 8 + floor((level-1) * (18 - 8) / (30 - 1)) → приблизительно 8..18.
- Таймер в версии 1.2 / 1.3 / 1.4:
  - Per-question timer = 5 секунд на вопрос.
  - Герои/предметы могут давать доп. секунды на вопрос (timerExtraSeconds), которые суммируются к базовым 5s.
- ИгрокHP (без героя) = 3; герои могут менять HP.
- Число нужных правильных ответов = начальный HP монстра.
- KPI тестирования баланса:
  - Среднее время на ответ (целевой диапазон 3–8s для детей 7–10).
  - Success rate по уровням и этапам.

8. Монетизация и модель оплаты (текущий статус)
Текущее состояние (версия 0.5):
- Все уровни бесплатны.
- Монеты выдаются исключительно за внутриигровые достижения (решение задач, победы).
- Внешних покупок (IAP) в MVP нет — магазины/покупки работают только с game coins.

Планы на будущее (опционально после MVP):
- Введение IAP: Unlock All / Coin Packs / Cosmetic Heroes.
- Rewarded Ads: опция просмотра рекламы в обмен на монеты/continue.
- Серверная верификация транзакций и restore purchases.

9. Интерфейс / UX / экраны
Главные экраны:
- IntroPage (логотип, Play)
- MainMenu: Play / Shop / Heroes / Progress / Settings
- TutorialPage: интерактивный туториал
- StageSelectPage: список 6 этапов (краткий обзор каждого этапа)
- StageIntroPage: экран-интро для выбранного этапа (название, описание, цель, кнопка "Начать этап")
- LevelSelectPage: внутри этапа 5 уровней, индикаторы прогресса
- HeroSelectPage: выбор/покупка героев за монеты
- BattlePage: основной экран (см. Core loop)
  - На BattlePage отображается per-question таймер (5s) рядом с вариантами ответа.
  - RoundIntro — промежуточный экран-пауза между раундами (появляется до появления нового монстра).
- LevelCompleteModal и FailModal
- ShopPage и ProgressPage

UX-детали:
- StageIntro и RoundIntro разделяют поток прохождения, уменьшают монотонность и дают игроку подготовку.
- RoundIntro должен быть коротким, информативным и не прерывать динамику.
- Ответы — крупные кнопки (font-size 20–26px), быстрый feedback (правильно/неправильно).
- Подсвечивание правильного варианта после ответа.
- Визуальные эффекты при попадании/ошибке, а также индикатор таймера (ленточная полоса + числа).

10. Туториал и онбоардинг
- Интерактивный туториал для первого входа:
  - Объяснение механики (как наносить урон, штраф за ошибку, per-question таймер).
  - Пробный пример с подсказкой.
  - Первая победа с небольшим вознаграждением (монеты).
- StageIntro и RoundIntro можно использовать как «микро-обучение» (подсказки перед этапом/раундом).

11. Магазин / внутриигровая валюта / покупки за монеты
- Coins — soft currency, выдаётся за успешные действия.
- В магазине:
  - Heroes (coins)
  - Consumables: revive, solveOnce, extraHP
  - Cosmetics (future)
- Цена и экономика:
  - initial pricing set in config; monitored & tuned from analytics.
  - Решение примера — недорогая опция (например 5 coins).
  - Revive — более дорогая опция (30 coins).
- Операции:
  - Клиент списывает монеты и применяет эффект, сервер (при наличии) верифицирует и сохраняет.

12. Сценарии проигрыша и продолжения
- Проигрыш = playerHP <= 0:
  - Показывается FailModal:
    - Опции: Revive за N coins (продолжить тот же уровень), Buy new hero (если доступно), Start over (возврат в меню).
- Тайм-аут на примере:
  - Если игрок не отвечает за 5 секунд — с него снимается 1 HP и показывается краткий feedback. Если это лишает игрока всех HP → FailModal.
- RoundIntro и проигрыши:
  - RoundIntro даёт возможность игроку подготовиться и снизить вероятность пропусков.
  - Если игрок многократно проигрывает на одном уровне, предлагается подсказка или уменьшение сложности через предмет/героя.

13. Арт- и аудиоспецификации
- StageIntro art: баннер этапа, иконка этапа, короткий текст (30–60 символов).
- RoundIntro art: небольшая иконка/подсказка и кнопка "Дальше".
- Остальные спецификации — см. v1.3 (PNG, размеры, звук и т.п.).

14. Техничесные требования и архитектура
- Stage и Round metadata: уровни сгруппированы по этапам в конфиге; для RoundIntro нужны поля (title, hint, icon).
- Пример структуры:
  - stages: [{ id, name, description, banner, levels: [{ levelId, monsterHP, minFactor, maxFactor, timerPerQuestionSeconds, roundIntro }] }]

15. Данные, API и модели данных
- Level config добавленное поле:
  - { stageId, level, monsterHP, minFactor, maxFactor, timerPerQuestionSeconds, roundIntro: { title, hint, icon } }
- API (при наличии сервера) должен поддерживать загрузку stage/round metadata и синхронизацию прогресса по этапам.

16. Тестирование, аналитика и метрики
- Отслеживать события:
  - stage_start, stage_complete, stage_fail,
  - round_intro_shown, round_started, question_shown, timeout_occurred.
- Аналитика поможет выявить проблемные этапы/раунды и корректировать подсказки/Difficulty.

17. План разработки и вехи (детализированный)
Фаза A — MVP (7–10 дн)
- A1 Scaffold + assets (0.5–1d)
- A2 Порт логики v2.1 + BattlePage (1.5–2d) — обновить таймерную логику на per-question timer.
- A3 StageSelect + StageIntro + LevelSelect + HeroSelect + RoundIntro (1–1.5d) — добавить экран этапа, RoundIntro и разбить 30 уровней на 6 этапов.
- A4 Shop (coins-only) + Revive flow (1.5d)
- A5 Tutorial + Intro (0.5–1d)
- A6 QA & analytics basics (1–1.5d)

Фаза B — Backend & Monetization (опционально)
- B1 API + DB (2–3d)
- B2 Payment integration / ads (1–2d)
- B3 Paywall flows (1–2d)

Фаза C — Полировка, звук, mobile polish (3–5d)

18. Acceptance criteria / Критерии приемки (MVP)
- Работают core mechanics: генерация задач, ответы, HP, per-question таймер (5s), победа/поражение.
- Stage flow: 6 этапов по 5 уровней, StageIntro отображается при переходе на новый этап.
- Round flow: перед каждым новым раундом отображается RoundIntro с кнопкой "Дальше", и при нажатии начинается следующий раунд.
- Регистрация/сохранение прогресса в localStorage (и на сервере при наличии).
- Магазин позволяет тратить внутриигровые монеты (без реальных платежей).
- Tutorial и LevelSelect доступны.
- Unit-tests для генератора задач и таймерной логики проходят.

19. Риски и меры по снижению
- Риск: Разбиение на этапы и добавление RoundIntro может замедлить темп и снизить вовлечённость.
  - Мера: RoundIntro краткий, не навязываемый (без таймера), можно предлагать опцию "Авто" для опытных игроков.
- Риск: Перегрузка информацией в RoundIntro.
  - Мера: оставить только ключевую подсказку и, при необходимости, ссылку на подробности.
- Риск: Некорректная балансировка этапов.
  - Мера: playtests и аналитика; возможность быстро менять min/max факторов через конфиг.

20. Приложения: примеры экранов и конфигурации
- Stage + Level + Round config:
```json
{
  "stageId": 3,
  "stageName": "Астероидная арена",
  "stageBanner": "assets/ui/stage_03_banner.png",
  "level": 10,
  "monsterHP": 11,
  "minFactor": 2,
  "maxFactor": 9,
  "timerPerQuestionSeconds": 5,
  "roundIntro": {
    "title": "Режим ускорения",
    "hint": "Ожидайте больше примеров с множителем 9–12",
    "icon": "assets/ui/round_hint_accel.png"
  }
}
```

- Hero config:
```json
{
  "id": "hero_01",
  "name": "Рыцарь",
  "coinsCost": 300,
  "stats": {
    "hpBonus": 1,
    "timerExtraSeconds": 0,
    "skipCostDiscount": 0
  },
  "sprite": "assets/heroes/hero_01.png"
}
```

---

Что сделано сейчас
- GDD обновлён до v1.4: добавлена обязательная пауза RoundIntro перед каждым новым раундом (монстром), Changelog обновлён, поправлены Core loop, интерфейс и планы разработки.

Дальше
- Могу: 1) разбить изменения в GDD на actionable issues (backlog) с приоритетами и оценками, 2) подготовить skeleton проекта и интегрировать per-question таймер + RoundIntro + stage flow, 3) внести изменения прямо в game.js (патч) чтобы реализовать RoundIntro и поведение «timeout = −1 HP» при per-question таймере. Выберите предпочтительный следующий шаг.
```
```
